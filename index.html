<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diário de Gastos</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #F0F4F8;
            --text-primary: #1A202C;
            --highlight: #059669;
            --card-bg: #FFFFFF;
        }
        .dark {
            --bg-primary: #1A1A1A;
            --text-primary: #F0F0F0;
            --highlight: #059669;
            --card-bg: #1F2937;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 400px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            background-color: var(--card-bg);
            transition: background-color 0.3s ease;
        }
        .text-highlight {
            color: var(--highlight);
        }
        .bg-highlight {
            background-color: var(--highlight);
        }
        .border-highlight {
            border-color: var(--highlight);
        }
        
        input, select, textarea {
            background-color: var(--card-bg);
        }
        .edit-button {
            background-color: #34D399;
            color: white;
            padding: 0.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .edit-button:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container rounded-2xl shadow-lg">
        <!-- Header -->
        <header class="flex justify-between items-center py-4 px-2">
            <h1 class="text-2xl font-bold text-highlight">Diário de Gastos</h1>
             <div class="flex items-center gap-2">
                <a href="./consolidar/index.html" class="px-3 py-2 text-sm font-semibold text-highlight border-2 border-highlight rounded-lg hover:bg-highlight hover:text-white transition-colors duration-300">
                    Consolidar
                </a>
                <button id="theme-toggle" class="p-2 rounded-full border-2 border-highlight">
                    <svg id="moon-icon" class="w-6 h-6 text-highlight hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                    <svg id="sun-icon" class="w-6 h-6 text-highlight" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </button>
            </div>
        </header>
        <!-- Descrição e Orientação -->
        <div class="bg-card-bg p-4 rounded-lg shadow-md mb-4 text-sm text-gray-500">
            <ul class="list-disc list-inside mt-2 text-left">
                <li>
                    <b>Registro de Dados</b>: Preencher
                    os campos de data, valor, forma de pagamento, categoria e uma breve descrição
                    para registrar seu gasto.
                </li>
                <li>
                    <b>Meus Gastos</b>: Listar seus registros de forma organizada.
                    Use os filtros para ver os gastos de cada forma de pagamento
                    (Débito, Crédito e Dinheiro).
                </li>
                <li>
                    <b>Exportar</b>: Em "Meus Gastos", exportar para JSON após concluir entradas do dia e então limpar a lista.
                </li>
            </ul>
        </div>
        <!-- Navigation -->
        <nav class="flex justify-around my-4">
            <button id="btn-add" class="flex-1 p-3 text-sm font-semibold text-center border-b-2 border-highlight text-highlight">
                Registro de Dados
            </button>
            <button id="btn-view" class="flex-1 p-3 text-sm font-semibold text-center text-gray-500 hover:text-highlight transition-colors duration-300">
                Meus Gastos
            </button>
        </nav>

        <!-- Main content areas -->
        <main class="flex-1">
            <!-- Register Section (Registro de Dados) -->
            <section id="register-section" class="flex flex-col gap-4">
                <form id="expense-form" class="flex flex-col gap-4">
                    <!-- Data -->
                    <div>
                        <label for="date-input" class="block mb-1 text-sm font-medium">Data</label>
                        <input type="date" id="date-input" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-highlight focus:border-highlight text-sm transition-colors duration-300">
                    </div>

                    <!-- Valor -->
                    <div>
                        <label for="value-input" class="block mb-1 text-sm font-medium">Valor</label>
                        <div class="relative">
                            <input type="text" id="value-input" placeholder="R$ 0,00" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-highlight focus:border-highlight text-sm transition-colors duration-300">
                        </div>
                    </div>

                    <!-- Forma de Pagamento -->
                    <div>
                        <label for="payment-method" class="block mb-1 text-sm font-medium">Forma de Pagamento</label>
                        <select id="payment-method" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-highlight focus:border-highlight text-sm transition-colors duration-300">
                            <option value="Credito">Crédito</option>
                            <option value="Debito" selected>Débito</option>
                            <option value="Dinheiro">Dinheiro</option>
                        </select>
                    </div>

                    <!-- Categoria -->
                    <div>
                        <label for="category" class="block mb-1 text-sm font-medium">Categoria</label>
                        <select id="category" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-highlight focus:border-highlight text-sm transition-colors duration-300">
                            <option value="Produto">Produto</option>
                            <option value="Servico">Serviço</option>
                            <option value="Transferencia">Transferência</option>
                            <option value="Divida">Dívida</option>
                        </select>
                    </div>

                    <!-- Descrição -->
                    <div>
                        <label for="description-input" class="block mb-1 text-sm font-medium">Descrição Detalhada</label>
                        <textarea id="description-input" rows="3" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-highlight focus:border-highlight text-sm transition-colors duration-300"></textarea>
                    </div>

                    <button type="submit" class="w-full py-3 bg-highlight text-white font-semibold rounded-lg shadow-md transition-transform duration-300 transform hover:scale-105">
                        Registrar Gasto
                    </button>
                </form>
            </section>

            <!-- View Section (Meus Gastos) -->
            <section id="view-section" class="flex flex-col gap-4 hidden">
                <!-- Filter buttons -->
                <div class="flex justify-around bg-card-bg p-1 rounded-full shadow">
                    <button data-filter="Debito" class="flex-1 py-2 px-4 rounded-full text-sm font-semibold transition-colors duration-300 bg-highlight text-white">Débito</button>
                    <button data-filter="Credito" class="flex-1 py-2 px-4 rounded-full text-sm font-semibold text-gray-500 hover:text-highlight transition-colors duration-300">Crédito</button>
                    <button data-filter="Dinheiro" class="flex-1 py-2 px-4 rounded-full text-sm font-semibold text-gray-500 hover:text-highlight transition-colors duration-300">Dinheiro</button>
                </div>

                <!-- Chart container -->
                <div class="p-4 rounded-lg shadow">
                    <h2 class="text-center font-bold mb-2">Visão Geral dos Gastos por Categoria</h2>
                    <canvas id="expense-chart"></canvas>
                </div>

                <!-- Total -->
                <div class="flex flex-col items-center p-4 rounded-lg">
                    <p class="text-sm font-medium">Total da Lista:</p>
                    <p id="total-display" class="text-3xl font-bold text-highlight mt-1">R$ 0,00</p>
                </div>

                <!-- Expenses list -->
                <ul id="expense-list" class="flex flex-col gap-3 flex-1 overflow-y-auto">
                    <!-- Dynamic list items will be inserted here -->
                </ul>

                <!-- Action buttons -->
                <div class="flex gap-4 mt-4">
                    <button id="export-json" class="flex-1 py-3 bg-highlight text-white font-semibold rounded-lg shadow-md transition-transform duration-300 transform hover:scale-105">
                        Exportar para JSON
                    </button>
                    <button id="clear-entries" class="flex-1 py-3 bg-highlight text-white font-semibold rounded-lg shadow-md transition-transform duration-300 transform hover:scale-105">
                        Limpar Entradas
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Custom Modals -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-card-bg p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 flex flex-col items-center">
            <p id="modal-message" class="text-lg text-center mb-4"></p>
            <div id="modal-buttons" class="flex gap-4">
                <button id="modal-ok-btn" class="py-2 px-4 bg-highlight text-white font-semibold rounded-lg">OK</button>
                <button id="modal-cancel-btn" class="py-2 px-4 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Expense Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-card-bg p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
            <h2 class="text-xl font-bold mb-4">Editar Gasto</h2>
            <form id="edit-form" class="flex flex-col gap-4">
                <input type="hidden" id="edit-expense-id">
                <div>
                    <label for="edit-date" class="block mb-1 text-sm font-medium">Data</label>
                    <input type="date" id="edit-date" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-highlight focus:border-highlight text-sm transition-colors duration-300">
                </div>
                <div>
                    <label for="edit-value" class="block mb-1 text-sm font-medium">Valor</label>
                    <input type="text" id="edit-value" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-highlight focus:border-highlight text-sm transition-colors duration-300">
                </div>
                <div>
                    <label for="edit-payment-method" class="block mb-1 text-sm font-medium">Forma de Pagamento</label>
                    <select id="edit-payment-method" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-highlight focus:border-highlight text-sm transition-colors duration-300">
                        <option value="Credito">Crédito</option>
                        <option value="Debito">Débito</option>
                        <option value="Dinheiro">Dinheiro</option>
                    </select>
                </div>
                <div>
                    <label for="edit-category" class="block mb-1 text-sm font-medium">Categoria</label>
                    <select id="edit-category" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-highlight focus:border-highlight text-sm transition-colors duration-300">
                        <option value="Produto">Produto</option>
                        <option value="Servico">Serviço</option>
                        <option value="Transferencia">Transferência</option>
                        <option value="Divida">Dívida</option>
                    </select>
                </div>
                <div>
                    <label for="edit-description" class="block mb-1 text-sm font-medium">Descrição Detalhada</label>
                    <textarea id="edit-description" rows="3" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-highlight focus:border-highlight text-sm transition-colors duration-300"></textarea>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" id="edit-cancel-btn" class="py-2 px-4 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold rounded-lg">Cancelar</button>
                    <button type="submit" class="py-2 px-4 bg-highlight text-white font-semibold rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Temporary Message Popup -->
    <div id="temp-message" class="fixed top-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-lg transition-opacity duration-300 opacity-0 hidden">
        <p>Gasto registrado com sucesso!</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- Variáveis globais e elementos do DOM ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const body = document.body;

            const btnAdd = document.getElementById('btn-add');
            const btnView = document.getElementById('btn-view');
            const registerSection = document.getElementById('register-section');
            const viewSection = document.getElementById('view-section');

            const expenseForm = document.getElementById('expense-form');
            const dateInput = document.getElementById('date-input');
            const valueInput = document.getElementById('value-input');
            const paymentMethodSelect = document.getElementById('payment-method');
            const categorySelect = document.getElementById('category');
            const descriptionInput = document.getElementById('description-input');

            const filterButtons = document.querySelectorAll('#view-section button[data-filter]');
            const expenseList = document.getElementById('expense-list');
            const totalDisplay = document.getElementById('total-display');
            const exportJsonBtn = document.getElementById('export-json');
            const clearEntriesBtn = document.getElementById('clear-entries');
            
            // Modal elements
            const customModal = document.getElementById('custom-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalOkBtn = document.getElementById('modal-ok-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            
            // Edit modal elements
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const editExpenseId = document.getElementById('edit-expense-id');
            const editDateInput = document.getElementById('edit-date');
            const editValueInput = document.getElementById('edit-value');
            const editPaymentMethodSelect = document.getElementById('edit-payment-method');
            const editCategorySelect = document.getElementById('edit-category');
            const editDescriptionInput = document.getElementById('edit-description');
            const editCancelBtn = document.getElementById('edit-cancel-btn');

            // Temporary message element
            const tempMessage = document.getElementById('temp-message');

            let db;
            let currentFilter = 'Debito';
            let expenseChart = null;

            // --- Lógica de Modo Escuro/Claro ---
            const setTheme = (theme) => {
                if (theme === 'dark') {
                    body.classList.add('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    body.classList.remove('dark');
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                }
                localStorage.setItem('theme', theme);
            };

            themeToggleBtn.addEventListener('click', () => {
                const currentTheme = body.classList.contains('dark') ? 'light' : 'dark';
                setTheme(currentTheme);
            });

            const initialTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            setTheme(initialTheme);

            // --- Lógica de navegação entre seções ---
            const showSection = async (sectionId) => {
                registerSection.classList.add('hidden');
                viewSection.classList.add('hidden');
                btnAdd.classList.remove('border-highlight', 'text-highlight');
                btnAdd.classList.add('text-gray-500');
                btnView.classList.remove('border-highlight', 'text-highlight');
                btnView.classList.add('text-gray-500');

                if (sectionId === 'register-section') {
                    registerSection.classList.remove('hidden');
                    btnAdd.classList.add('border-b-2', 'border-highlight', 'text-highlight');
                } else {
                    viewSection.classList.remove('hidden');
                    btnView.classList.add('border-b-2', 'border-highlight', 'text-highlight');
                    await renderExpenses(currentFilter);
                }
            };
            
            btnAdd.addEventListener('click', () => showSection('register-section'));
            btnView.addEventListener('click', () => showSection('view-section'));

            // --- IndexedDB: Inicialização e Gerenciamento do Banco de Dados ---
            const openDatabase = () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('financeDb', 1);

                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        const objectStore = db.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                        objectStore.createIndex('paymentMethod', 'paymentMethod', { unique: false });
                    };

                    request.onsuccess = (event) => {
                        db = event.target.result;
                        resolve(db);
                    };

                    request.onerror = (event) => {
                        console.error('Erro ao abrir o banco de dados:', event.target.errorCode);
                        reject(event.target.errorCode);
                    };
                });
            };

            await openDatabase();

            // --- Funções do Modal Personalizado e da mensagem temporária ---
            const showModal = (message, isConfirm = false) => {
                return new Promise(resolve => {
                    modalMessage.textContent = message;
                    if (isConfirm) {
                        modalOkBtn.textContent = 'Sim';
                        modalCancelBtn.classList.remove('hidden');
                    } else {
                        modalOkBtn.textContent = 'OK';
                        modalCancelBtn.classList.add('hidden');
                    }
                    customModal.classList.remove('hidden');

                    modalOkBtn.onclick = () => {
                        customModal.classList.add('hidden');
                        resolve(true);
                    };
                    modalCancelBtn.onclick = () => {
                        customModal.classList.add('hidden');
                        resolve(false);
                    };
                });
            };

            const showTemporaryMessage = (message) => {
                tempMessage.textContent = message;
                tempMessage.classList.remove('hidden');
                setTimeout(() => {
                    tempMessage.classList.add('opacity-0');
                    setTimeout(() => tempMessage.classList.add('hidden'), 300);
                }, 3000);
                tempMessage.classList.remove('opacity-0');
            };

            // --- Função de formatação de moeda brasileira (R$ 0.000,00) ---
            const formatCurrency = (value, includeSymbol = true) => {
                if (typeof value === 'string') {
                    value = value.replace(/\D/g, '');
                }
                let num = Number(value) / 100;
                
                const formatter = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                });

                if (includeSymbol) {
                    return formatter.format(num);
                } else {
                    return num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
            };

            // --- Funções de interação com o IndexedDB ---
            const addExpenseToDb = (expense) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['expenses'], 'readwrite');
                    const objectStore = transaction.objectStore('expenses');
                    const request = objectStore.add(expense);

                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            };

            const updateExpenseInDb = (expense) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['expenses'], 'readwrite');
                    const objectStore = transaction.objectStore('expenses');
                    const request = objectStore.put(expense);

                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            };

            const getExpensesFromDb = (filter) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['expenses'], 'readonly');
                    const objectStore = transaction.objectStore('expenses');
                    
                    const index = objectStore.index('paymentMethod');
                    const request = index.getAll(filter);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            };
            
            const clearExpensesInDb = (filter) => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(['expenses'], 'readwrite');
                    const objectStore = transaction.objectStore('expenses');
                    const index = objectStore.index('paymentMethod');
                    const request = index.openCursor(IDBKeyRange.only(filter));

                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            objectStore.delete(cursor.primaryKey);
                            cursor.continue();
                        } else {
                            resolve();
                        }
                    };
                    request.onerror = (e) => reject(e.target.error);
                });
            };

            // --- Funcionalidade 1: Registro de Gastos ---
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;

            valueInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                e.target.value = formatCurrency(value);
            });

            expenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const rawValue = valueInput.value.replace(/\D/g, '');
                if (!rawValue) return;

                const newExpense = {
                    date: dateInput.value,
                    value: parseFloat(rawValue) / 100, // Salva o valor como número
                    paymentMethod: paymentMethodSelect.value,
                    category: categorySelect.value,
                    description: descriptionInput.value
                };

                await addExpenseToDb(newExpense);

                expenseForm.reset();
                dateInput.value = `${year}-${month}-${day}`;
                valueInput.value = '';
                showTemporaryMessage('Gasto registrado com sucesso!');

                await renderExpenses(currentFilter);
            });

            // --- Funcionalidade 2: Meus Gastos ---
            const renderChart = (expenses) => {
                if (expenseChart) {
                    expenseChart.destroy();
                }

                const categoryTotals = {};
                expenses.forEach(expense => {
                    categoryTotals[expense.category] = (categoryTotals[expense.category] || 0) + expense.value;
                });
                
                const labels = Object.keys(categoryTotals);
                const data = Object.values(categoryTotals);
                
                const colors = {
                    'Produto': '#059669',
                    'Servico': '#34D399',
                    'Transferencia': '#6EE7B7',
                    'Divida': '#A7F3D0'
                };

                const backgroundColors = labels.map(label => colors[label] || '#9CA3AF');

                const ctx = document.getElementById('expense-chart').getContext('2d');
                expenseChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                        return `${label}: ${formatCurrency(value * 100)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            const renderExpenses = async (filter) => {
                expenseList.innerHTML = '';
                let total = 0;

                const expenses = await getExpensesFromDb(filter);
                
                // Renderiza o gráfico
                renderChart(expenses);

                if (expenses.length === 0) {
                    expenseList.innerHTML = `<li class="text-center text-gray-400 mt-8">Nenhum gasto encontrado para esta categoria.</li>`;
                }

                expenses.forEach(expense => {
                    const numericValue = expense.value;
                    total += numericValue;

                    const listItem = document.createElement('li');
                    listItem.classList.add('p-4', 'rounded-lg', 'shadow', 'flex', 'flex-col', 'gap-1', 'expense-item');
                    listItem.dataset.id = expense.id;
                    listItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="text-sm font-semibold">${expense.date.split('-').reverse().join('/')}</span>
                                <span class="text-lg font-bold text-highlight ml-2">${formatCurrency(expense.value * 100)}</span>
                            </div>
                            <button class="edit-button" data-id="${expense.id}" aria-label="Editar">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM2 13.5V18h4.5l9.5-9.5-4.5-4.5-9.5 9.5z" clip-rule="evenodd" fill-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
                            <span>Categoria: ${expense.category}</span>
                            <span>Descrição: ${expense.description}</span>
                        </div>
                    `;
                    expenseList.appendChild(listItem);
                });

                totalDisplay.textContent = formatCurrency(total * 100);
                currentFilter = filter;
                
                filterButtons.forEach(btn => {
                    if (btn.dataset.filter === filter) {
                        btn.classList.add('bg-highlight', 'text-white');
                        btn.classList.remove('text-gray-500', 'hover:text-highlight');
                    } else {
                        btn.classList.remove('bg-highlight', 'text-white');
                        btn.classList.add('text-gray-500', 'hover:text-highlight');
                    }
                });
            };

            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    renderExpenses(button.dataset.filter);
                });
            });

            // --- Funcionalidade de Edição ---
            expenseList.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-button');
                if (editBtn) {
                    const expenseId = parseInt(editBtn.dataset.id);
                    const transaction = db.transaction(['expenses'], 'readonly');
                    const objectStore = transaction.objectStore('expenses');
                    const request = objectStore.get(expenseId);
                    
                    request.onsuccess = () => {
                        const expenseToEdit = request.result;
                        if (expenseToEdit) {
                            // Popula o modal de edição com os dados
                            editExpenseId.value = expenseToEdit.id;
                            editDateInput.value = expenseToEdit.date;
                            editValueInput.value = formatCurrency(expenseToEdit.value * 100, false);
                            editPaymentMethodSelect.value = expenseToEdit.paymentMethod;
                            editCategorySelect.value = expenseToEdit.category;
                            editDescriptionInput.value = expenseToEdit.description;
                            
                            // Mostra o modal de edição
                            editModal.classList.remove('hidden');
                        }
                    };
                }
            });

            editValueInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                e.target.value = formatCurrency(value, false);
            });

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const rawValue = editValueInput.value.replace(/\D/g, '');
                if (!rawValue) return;

                const updatedExpense = {
                    id: parseInt(editExpenseId.value),
                    date: editDateInput.value,
                    value: parseFloat(rawValue) / 100,
                    paymentMethod: editPaymentMethodSelect.value,
                    category: editCategorySelect.value,
                    description: editDescriptionInput.value
                };

                await updateExpenseInDb(updatedExpense);
                editModal.classList.add('hidden');
                showTemporaryMessage('Gasto atualizado com sucesso!');
                await renderExpenses(currentFilter);
            });

            editCancelBtn.addEventListener('click', () => {
                editModal.classList.add('hidden');
            });


            await renderExpenses('Debito');

            exportJsonBtn.addEventListener('click', async () => {
                const expensesToExport = await getExpensesFromDb(currentFilter);
                if (expensesToExport.length === 0) {
                    await showModal('Não há dados para exportar.');
                    return;
                }
                
                // Formata o timestamp para o ID e nome do arquivo
                const now = new Date();
                const pad = (num) => String(num).padStart(2, '0');
                const pad3 = (num) => String(num).padStart(3, '0');
                const timestampId = `${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}${pad3(now.getMilliseconds())}`;
                const fileName = `gastos_${timestampId}.json`;

                // Constrói o objeto JSON final com o timestamp no início e a lista de entradas
                const exportData = {
                    timestamp: timestampId,
                    entries: expensesToExport.map(expense => {
                        return {
                            DATA: expense.date.split('-').reverse().join('/'),
                            VALOR: formatCurrency(expense.value * 100),
                            'FORMA PGTO': expense.paymentMethod,
                            CATEGORIA: expense.category,
                            DESCRIÇÃO: expense.description
                        };
                    })
                };

                const jsonContent = JSON.stringify(exportData, null, 2);
                
                const blob = new Blob([jsonContent], { type: 'application/json' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', fileName);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    await showModal('Seu navegador não suporta a exportação de arquivos JSON diretamente.');
                }
            });

            clearEntriesBtn.addEventListener('click', async () => {
                const isConfirmed = await showModal(`Tem certeza que deseja limpar todos os gastos da categoria "${currentFilter}"?`, true);
                if (isConfirmed) {
                    await clearExpensesInDb(currentFilter);
                    await renderExpenses(currentFilter);
                }
            });
        });
    </script>
</body>
</html>

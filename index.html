<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Gastos</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --bg-color-light: #f0f2f5;
            --bg-color-dark: #000000;
            --text-color-light: #2c3e50;
            --text-color-dark: #ecf0f1;
            --card-bg-light: #ffffff;
            --card-bg-dark: #1c1c1c;
            --primary-color: #9370DB; /* Lilás */
            --primary-color-dark: #7e57c2;
            --input-border-light: #ccc;
            --input-border-dark: #333;
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-dark: 0 4px 12px rgba(0, 0, 0, 0.3);
            --button-text-color: #ffffff;
            --button-bg-light: #ddd;
            --button-bg-dark: #262626; /* Cor ligeiramente mais clara para maior contraste */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        .container {
            width: 100%;
            max-width: 500px;
            background-color: var(--card-bg-light);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            transition: background-color 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
        }

        body.dark-mode .container {
            background-color: var(--card-bg-dark);
            box-shadow: var(--shadow-dark);
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border-light);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            background-color: transparent;
            color: var(--text-color-light);
            transition: border-color 0.3s, color 0.3s;
        }

        body.dark-mode input, body.dark-mode textarea {
            border-color: var(--input-border-dark);
            color: var(--text-color-dark);
        }

        button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: var(--button-text-color);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--primary-color-dark);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .button-group button {
            flex: 1;
            padding: 10px;
            background-color: var(--button-bg-light);
            color: var(--text-color-light);
            font-size: 14px;
            border: 1px solid var(--input-border-light);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body.dark-mode .button-group button {
            background-color: var(--button-bg-dark);
            color: var(--text-color-dark);
            border: 1px solid var(--input-border-dark);
        }

        /* Estilos para o botão selecionado em ambos os modos */
        .button-group button.selected {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            border-color: var(--primary-color);
        }

        body.dark-mode .button-group button.selected {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            border-color: var(--primary-color);
        }

        #exportar-csv {
            background-color: #34a853;
        }
        #limpar-gastos {
            background-color: #e74c3c;
        }
        #exportar-csv:hover {
            background-color: #2b8440;
        }
        #limpar-gastos:hover {
            background-color: #c0392b;
        }

        #modo-escuro-btn {
            background-color: #2c3e50;
        }

        #modo-escuro-btn:hover {
            background-color: #1a242f;
        }

        .message {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: var(--text-color-light);
        }

        body.dark-mode .message {
            color: var(--text-color-dark);
        }

        #gastos-lista {
            margin-top: 30px;
        }

        #gastos-lista h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        #lista-gastos {
            list-style: none;
            padding: 0;
        }

        #lista-gastos li {
            background-color: var(--card-bg-light);
            border: 1px solid var(--input-border-light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.5;
            transition: background-color 0.3s, border-color 0.3s;
        }

        body.dark-mode #lista-gastos li {
            background-color: var(--card-bg-dark);
            border-color: var(--input-border-dark);
        }

        #total-valor {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
            color: var(--primary-color);
        }

        #ver-mais-btn {
            margin-top: 15px;
            background-color: #555;
            display: none; /* Inicia como escondido */
        }
        #ver-mais-btn:hover {
            background-color: #333;
        }
        
        .flex-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .flex-row button {
            flex: 1;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>REGISTRO DE GASTO</h1>
        <form id="gasto-form">
            <div class="form-group">
                <label for="data">Data:</label>
                <input type="date" id="data" required>
            </div>
            <div class="form-group">
                <label for="valor">Valor (R$):</label>
                <input type="number" id="valor" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="descricao">Descrição:</label>
                <textarea id="descricao" rows="2" placeholder="Detalhe aqui o gasto, do que se trata" required></textarea>
            </div>

            <div class="form-group">
                <label>Forma de Pagamento:</label>
                <div class="button-group" id="forma-pagamento-group">
                    <button type="button" data-value="Credito">Crédito</button>
                    <button type="button" data-value="Debito">Débito</button>
                </div>
                <input type="hidden" id="tipoPagamento" required>
            </div>

            <div class="form-group">
                <label>Tipo de Pagamento:</label>
                <div class="button-group" id="tipo-pagamento-group">
                    <button type="button" data-value="Produto">Produto</button>
                    <button type="button" data-value="Servico">Serviço</button>
                    <button type="button" data-value="Transferencia">Transferência</button>
                    <button type="button" data-value="Pagamento de Fatura">Pagamento de Fatura</button>
                </div>
                <input type="hidden" id="categoria" required>
            </div>

            <button type="submit">Adicionar Gasto</button>
        </form>
    </div>

    <div class="container">
        <div class="flex-row">
            <button id="exportar-csv" class="button-export">Exportar Gastos (.csv)</button>
            <button id="limpar-gastos">Limpar Gastos</button>
            <button id="modo-escuro-btn">Modo Escuro</button>
        </div>
        <div class="message">
            <p>Seus gastos são salvos no seu navegador e funcionam offline. Lembre-se de exportar ou fazer backup dos dados, pois a limpeza apaga o histórico permanentemente.</p>
        </div>
        <div id="gastos-lista">
            <h2>Últimos Gastos</h2>
            <ul id="lista-gastos"></ul>
            <div id="total-valor"></div>
            <button id="ver-mais-btn">Ver Mais</button>
        </div>
    </div>

    <script>
        // Registra o Service Worker para habilitar o PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('ServiceWorker registrado com sucesso:', registration.scope);
                }).catch(err => {
                    console.log('Registro do ServiceWorker falhou:', err);
                });
            });
        }

        const form = document.getElementById('gasto-form');
        const listaGastos = document.getElementById('lista-gastos');
        const totalValorDiv = document.getElementById('total-valor');
        const exportarCsvBtn = document.getElementById('exportar-csv');
        const limparGastosBtn = document.getElementById('limpar-gastos');
        const modoEscuroBtn = document.getElementById('modo-escuro-btn');
        const verMaisBtn = document.getElementById('ver-mais-btn');
        const formaPagamentoGroup = document.getElementById('forma-pagamento-group');
        const tipoPagamentoGroup = document.getElementById('tipo-pagamento-group');
        const tipoPagamentoInput = document.getElementById('tipoPagamento');
        const categoriaInput = document.getElementById('categoria');

        let gastosExibidos = 5;

        // Funções de gerenciamento de dados
        function getGastos() {
            const gastosJson = localStorage.getItem('gastos');
            return gastosJson ? JSON.parse(gastosJson) : [];
        }

        function saveGastos(gastos) {
            localStorage.setItem('gastos', JSON.stringify(gastos));
        }

        // Funções de exibição e UI
        function calcularTotal(gastos) {
            const total = gastos.reduce((sum, gasto) => sum + gasto.valor, 0);
            totalValorDiv.textContent = `Total: R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        function displayGastos() {
            const gastos = getGastos().reverse(); // Exibe os gastos do mais recente para o mais antigo
            listaGastos.innerHTML = ''; // Limpa a lista antes de exibir

            const gastosParaExibir = gastos.slice(0, gastosExibidos);
            if (gastosParaExibir.length === 0) {
                listaGastos.innerHTML = '<p style="text-align: center;">Nenhum gasto registrado ainda.</p>';
            } else {
                gastosParaExibir.forEach(gasto => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>Data:</strong> ${new Date(gasto.timestamp).toLocaleDateString('pt-BR')}<br>
                        <strong>Valor:</strong> R$ ${gasto.valor.toFixed(2).replace('.', ',')}<br>
                        <strong>Forma de Pagamento:</strong> ${gasto.tipoPagamento}<br>
                        <strong>Tipo de Pagamento:</strong> ${gasto.categoria}<br>
                        <strong>Descrição:</strong> ${gasto.descricao}
                    `;
                    listaGastos.appendChild(li);
                });
            }

            calcularTotal(getGastos());

            // Lógica para o botão "Ver Mais"
            if (gastos.length > gastosExibidos) {
                verMaisBtn.style.display = 'block';
            } else {
                verMaisBtn.style.display = 'none';
            }
        }

        function toggleModoEscuro() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            modoEscuroBtn.textContent = isDarkMode ? 'Modo Claro' : 'Modo Escuro';
        }

        // Event Listeners
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!tipoPagamentoInput.value || !categoriaInput.value) {
                alert('Por favor, selecione as opções de pagamento.');
                return;
            }

            const novoGasto = {
                data: document.getElementById('data').value,
                valor: parseFloat(document.getElementById('valor').value),
                descricao: document.getElementById('descricao').value,
                tipoPagamento: tipoPagamentoInput.value,
                categoria: categoriaInput.value,
                timestamp: new Date().toISOString()
            };

            const gastos = getGastos();
            gastos.push(novoGasto);
            saveGastos(gastos);

            form.reset();
            resetButtonGroups();
            gastosExibidos = 5; // Reseta a exibição para os 5 mais recentes
            displayGastos();
        });

        function resetButtonGroups() {
            formaPagamentoGroup.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
            tipoPagamentoGroup.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
            tipoPagamentoInput.value = '';
            categoriaInput.value = '';
        }

        function handleButtonGroupClick(event, hiddenInput) {
            const target = event.target;
            if (target.tagName === 'BUTTON') {
                target.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                target.classList.add('selected');
                hiddenInput.value = target.dataset.value;
            }
        }

        formaPagamentoGroup.addEventListener('click', (e) => handleButtonGroupClick(e, tipoPagamentoInput));
        tipoPagamentoGroup.addEventListener('click', (e) => handleButtonGroupClick(e, categoriaInput));

        exportarCsvBtn.addEventListener('click', () => {
            const gastos = getGastos();
            if (gastos.length === 0) {
                alert('Nenhum gasto para exportar.');
                return;
            }
            const dataAtual = new Date();
            const dia = String(dataAtual.getDate()).padStart(2, '0');
            const mes = String(dataAtual.getMonth() + 1).padStart(2, '0');
            const ano = dataAtual.getFullYear();
            const dataFormatada = `${dia}/${mes}/${ano}`;

            const totalValor = gastos.reduce((sum, gasto) => sum + gasto.valor, 0).toFixed(2);
            const nomeArquivo = `GASTOS_${dataFormatada}_R$${totalValor.replace('.', ',')}.csv`;

            const header = ['Data', 'Hora', 'Valor', 'Forma de Pagamento', 'Tipo de Pagamento', 'Descricao'];
            const csv = [
                header.join(','),
                ...gastos.map(gasto => {
                    const [ano, mes, dia] = gasto.data.split('-');
                    const dataFormatada = `${dia}-${mes}-${ano}`;
                    const hora = new Date(gasto.timestamp).toLocaleTimeString('pt-BR', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    return [
                        dataFormatada,
                        hora,
                        gasto.valor.toFixed(2).replace('.', ','),
                        gasto.tipoPagamento,
                        gasto.categoria,
                        `"${gasto.descricao.replace(/"/g, '""')}"`
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', nomeArquivo);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        limparGastosBtn.addEventListener('click', () => {
            const confirmacao = confirm('Tem certeza que deseja apagar todos os gastos? Esta ação é irreversível.');
            if (confirmacao) {
                localStorage.removeItem('gastos');
                gastosExibidos = 5; // Reseta a exibição para o padrão
                displayGastos(); // Atualiza a lista na tela
            }
        });

        verMaisBtn.addEventListener('click', () => {
            gastosExibidos += 5;
            displayGastos();
        });

        modoEscuroBtn.addEventListener('click', toggleModoEscuro);

        // Inicialização
        window.addEventListener('load', () => {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                modoEscuroBtn.textContent = 'Modo Claro';
            }
            displayGastos();
        });
    </script>
</body>
</html>
